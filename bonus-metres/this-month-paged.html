<!-- Save as: this-month.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Bonus Metres – Current Month’s Leaderboard</title>

  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      display: flex; flex-direction: column;
    }

    /* --- TITLE BLOCK (2 lines) --- */
    .title-block {
      text-align: center;
      margin: 20px 0 10px;
    }
    .title-main {
      font-size: 32px;
      font-weight: bold;
    }
    .title-sub {
      font-size: 18px;
      color: #444;
    }

    .nav-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-top: 6px;
    }
    .nav-arrow {
      font-size: 32px;
      cursor: pointer;
      user-select: none;
    }

    /* --- SEARCH UI --- */
    .search-container {
      position: relative;
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }
    .search-input {
      padding: 6px 10px;
      font-size: 16px;
      width: 60%;
      max-width: 400px;
      text-align: center;
    }
    .search-dropdown {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      max-width: 400px;
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      z-index: 10;
      display: none;
      max-height: 200px;
      overflow-y: auto;
    }
    .search-item {
      padding: 6px 10px;
      cursor: pointer;
      text-align: left;
      font-size: 14px;
    }
    .search-item:hover {
      background: #f0f0f0;
    }
    .search-item.disabled {
      cursor: default;
      color: #999;
    }

    table {
      width: 100%;
      max-width: 750px;
      margin: auto;
      border-collapse: collapse;
      table-layout: fixed;
    }

    th, td { padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
    img.face { border-radius: 50%; vertical-align: middle; }
    td.rank { font-weight: bold; }

    .static-section { flex-shrink: 0; }
    .scrollable-section { flex-grow: 1; overflow: hidden; position: relative; }
    .scrollable-inner {
      height: 100%; overflow-y: auto;
      scrollbar-width: none; -ms-overflow-style: none;
    }
    .scrollable-inner::-webkit-scrollbar { display: none; }

    /* --- HIGHLIGHTED RESULT ROW --- */
    .highlight-row {
      background-color: #fff7c2;
      transition: background-color 1s ease;
    }
  </style>
</head>

<body>

  <div class="static-section">
    <!-- TWO-LINE TITLE -->
    <div class="title-block">
      <div class="title-main">Bonus Metres – Current Month’s Leaderboard</div>

      <!-- Arrows either side of subtitle -->
      <div class="nav-row">
        <span class="nav-arrow" id="nav-prev">&#8592;</span>
        <div class="title-sub" id="title-sub">Positions</div>
        <span class="nav-arrow" id="nav-next">&#8594;</span>
      </div>

      <!-- SEARCH BAR + DROPDOWN -->
      <div class="search-container">
        <input
          id="searchBox"
          class="search-input"
          type="text"
          placeholder="Search for a name…"
        />
        <div id="searchDropdown" class="search-dropdown"></div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Rank</th>
          <th>Face</th>
          <th>Name</th>
          <th>Positional Change</th>
          <th>Bonus Metres</th>
          <th>Diff. from Leader</th>
        </tr>
      </thead>
      <tbody id="top-rank"></tbody>
    </table>
  </div>

  <div class="scrollable-section">
    <div class="scrollable-inner" id="scroll-container">
      <table>
        <tbody id="other-ranks"></tbody>
      </table>
    </div>
  </div>

<script>
/* -------------------- CONFIG -------------------- */

const CSV_URL  = '/bonus-metres/data/actual_distances.csv';
const IMG_PATH = '/img/';
const ITEMS_PER_PAGE = 8;   // blocks of 8

const PEOPLE = [
  'Adrian Lutic','Alex Nita','Antun Vidakovic','Bradley Turnstill','Byron Claridge',
  'Callum Evans','Cameron Gill','Christopher Scourfield','Connor Miles','Craig Dolan',
  'Darren Hatfield','David Mahon','Edward Shanley','Gary Mounce','George Norris',
  'James Hickman','James Hodge-Brooks','James Whiteoak','Jason Bligh',
  'Joe Lambourne-Gillen','Jonathan Thompson','Joseph Nixon','Joseph Young','Joshua Powell',
  'Joshua Rowberry','Lewis Cannon','Liam Hammon','Luke Piller','Mark Sneap',
  'Morgan Hemming','Nicholas Kingshott','Rhys Grant','Richard Clanford','Robert Tamas',
  'Ross Wills','Ryan Breslan','Ryan Manners','Sam Brooks','Tom Brooks',
  'Tristan Allen','Tyler Webb','Ross Striplin','Jordan Reynolds','Mark Stafford'
];

let ALL_ROWS = [];

/* -------------------- UTILITIES -------------------- */

function getPage() {
  const params = new URLSearchParams(location.search);
  const p = parseInt(params.get("page"), 10);
  return Number.isInteger(p) && p > 0 ? p : 1;
}

function getHighlightName() {
  const params = new URLSearchParams(location.search);
  return params.get('highlight') || null;
}

function gotoPage(newPage, highlightName) {
  const params = new URLSearchParams(location.search);
  params.set('page', newPage);
  if (highlightName) {
    params.set('highlight', highlightName);
  } else {
    params.delete('highlight');
  }
  location.search = params.toString();
}

async function loadImageElement(src, size) {
  return new Promise(res => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => res(img);
    img.onerror = () => {
      const c = document.createElement('canvas');
      c.width = c.height = size;
      const ctx = c.getContext('2d');
      ctx.fillStyle = '#ccc';
      ctx.fillRect(0, 0, size, size);
      res(c);
    };
    img.src = src;
  });
}

async function drawIcon(name, haloColor) {
  const base = 64;
  const halo = haloColor ? 10 : 0;
  const total = base + 2 * halo;
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const safe = encodeURIComponent(name.trim()) + '_cvface1.png';

  canvas.width = canvas.height = total;

  if (haloColor) {
    ctx.fillStyle = haloColor;
    ctx.beginPath();
    ctx.arc(total/2, total/2, base/2 + halo, 0, 2*Math.PI);
    ctx.arc(total/2, total/2, base/2, 0, 2*Math.PI);
    ctx.fill('evenodd');
  }

  const img = await loadImageElement(IMG_PATH + safe, base);
  ctx.drawImage(img, halo, halo, base, base);
  return canvas.toDataURL();
}

/* -------------------- CSV LOAD -------------------- */

async function fetchData() {
  const r = await fetch(CSV_URL, { cache: 'no-cache' });
  if (!r.ok) throw new Error('CSV failed: ' + r.status);
  const txt = await r.text();
  const lines = txt.trim().split(/\r?\n/);
  const keys = lines.shift().split(',').map(h => h.trim());
  return lines.map(l => {
    const cols = l.split(',');
    return keys.reduce((o, k, i) => (o[k] = (cols[i] || '').trim(), o), {});
  });
}

/* -------------------- MAIN BUILD -------------------- */

async function build() {
  const data = await fetchData();
  const rows = data
    .filter(r => r['T/M RANK'] && PEOPLE.includes(r['NAME']))
    .sort((a,b) => +a['T/M RANK'] - +b['T/M RANK']);

  if (!rows.length) return;

  const leaderValue = parseFloat((rows[0]['THIS MONTH'] || '0').replace(/,/g,'')) || 0;

  // Count how many share each T/M RANK (for "=" on ties)
  const counts = rows.reduce((acc, r) => {
    const rk = +r['T/M RANK'];
    acc[rk] = (acc[rk] || 0) + 1;
    return acc;
  }, {});

  // Display-rank calculation
  let lastRank = null;
  let displayRank = 0;

  rows.forEach((r, idx) => {
    const v = +r['T/M RANK'];
    if (v !== lastRank) {
      displayRank = idx + 1;
      lastRank = v;
    }
    r._display = displayRank;
    r._value = parseFloat((r['THIS MONTH'] || '0').replace(/,/g,'')) || 0;
    r._diff  = leaderValue - r._value;
    r._isTie = counts[v] > 1;
  });

  ALL_ROWS = rows;

  setupSearch();
  await renderCurrentPage();
}

/* -------------------- RENDER CURRENT PAGE -------------------- */

async function renderCurrentPage() {
  const rows = ALL_ROWS;
  if (!rows.length) return;

  const page  = getPage();
  const totalPages = Math.ceil(rows.length / ITEMS_PER_PAGE);
  const start = (page - 1) * ITEMS_PER_PAGE;
  const end   = Math.min(start + ITEMS_PER_PAGE, rows.length);

  const highlightName = getHighlightName();

  // Subtitle Positions X–Y
  const startPos = start + 1;
  const endPos   = end;
  document.getElementById("title-sub").textContent =
    `Positions ${startPos}–${endPos}`;

  // Arrows visibility + behaviour
  const prevArrow = document.getElementById("nav-prev");
  const nextArrow = document.getElementById("nav-next");

  prevArrow.style.visibility = page === 1 ? "hidden" : "visible";
  nextArrow.style.visibility = page === totalPages ? "hidden" : "visible";

  prevArrow.onclick = () => {
    if (page > 1) gotoPage(page - 1); // drop highlight on manual paging
  };
  nextArrow.onclick = () => {
    if (page < totalPages) gotoPage(page + 1); // drop highlight on manual paging
  };

  // Fill tables
  const topEl   = document.getElementById('top-rank');
  const otherEl = document.getElementById('other-ranks');
  topEl.innerHTML   = '';
  otherEl.innerHTML = '';

  for (let i = start; i < end; i++) {
    const r = rows[i];

    const halo =
      r._display === 1 ? 'gold' :
      r._display === 2 ? 'silver' :
      r._display === 3 ? '#cd7f32' : null;

    const icon = await drawIcon(r['NAME'], halo);
    const size = 64 + (halo ? 10 : 0);

    const tm = +r['T/M RANK'];
    const lm = +r['T/M LAST RANK'] || Infinity;
    const arrowImg =
      tm < lm ? 'Green%20Arrow.png' :
      tm > lm ? 'Red%20Arrow.png' :
      '';

    const metresTxt = r._value.toLocaleString() + 'm';
    const diffTxt   = r._diff === 0 ? 'Leader' : '-' + r._diff.toLocaleString() + 'm';

    const rankTxt = (r._isTie ? '=' : '') + r._display;

    const tr = document.createElement('tr');
    tr.dataset.name = r['NAME'];  // for highlighting
    tr.innerHTML = `
      <td class="rank">${rankTxt}</td>
      <td><img src="${icon}" width="${size}" height="${size}" class="face"></td>
      <td>${r['NAME']}</td>
      <td>${arrowImg ? `<img src="${IMG_PATH}${arrowImg}" width="32" height="32">` : ''}</td>
      <td>${metresTxt}</td>
      <td>${diffTxt}</td>
    `;

    // Leader on first page goes in the top table; others in scrollable table
    if (r._display === 1 && page === 1) {
      topEl.appendChild(tr);
    } else {
      otherEl.appendChild(tr);
    }
  }

  // Apply highlight if requested and visible on this page
  if (highlightName) {
    const allTrs = [
      ...topEl.querySelectorAll('tr'),
      ...otherEl.querySelectorAll('tr')
    ];
    const match = allTrs.find(tr => tr.dataset.name === highlightName);
    if (match) {
      match.classList.add('highlight-row');
      // Optionally auto-scroll within the scrollable area if not in the top table
      if (otherEl.contains(match)) {
        const container = document.getElementById('scroll-container');
        const rect = match.getBoundingClientRect();
        const crect = container.getBoundingClientRect();
        if (rect.top < crect.top || rect.bottom > crect.bottom) {
          container.scrollTop = match.offsetTop - 20;
        }
      }
    }
  }
}

/* -------------------- SEARCH WITH DROPDOWN + JUMP -------------------- */

function clearHighlightState() {
  // Remove highlight class from any row
  const highlighted = document.querySelector('.highlight-row');
  if (highlighted) {
    highlighted.classList.remove('highlight-row');
  }
  // Remove highlight param from URL without reloading
  const params = new URLSearchParams(location.search);
  if (params.has('highlight')) {
    params.delete('highlight');
    const newQuery = params.toString();
    const newUrl = window.location.pathname + (newQuery ? '?' + newQuery : '');
    history.replaceState(null, '', newUrl);
  }
}

function setupSearch() {
  const input = document.getElementById('searchBox');
  const dropdown = document.getElementById('searchDropdown');

  if (!input || !dropdown) return;

  function closeDropdown() {
    dropdown.style.display = 'none';
    dropdown.innerHTML = '';
  }

  // When user clicks back into the search box, drop any existing highlight
  input.addEventListener('focus', () => {
    clearHighlightState();
  });

  input.addEventListener('input', () => {
    const query = input.value.trim().toLowerCase();
    dropdown.innerHTML = '';

    if (!query) {
      closeDropdown();
      return;
    }

    const matches = ALL_ROWS.filter(r =>
      r['NAME'].toLowerCase().includes(query)
    );

    if (!matches.length) {
      dropdown.innerHTML = '<div class="search-item disabled">No matches</div>';
      dropdown.style.display = 'block';
      return;
    }

    // Build dropdown items (one per match)
    const frag = document.createDocumentFragment();
    matches.forEach(r => {
      const div = document.createElement('div');
      div.className = 'search-item';
      div.textContent = r['NAME'];
      div.dataset.name = r['NAME'];
      frag.appendChild(div);
    });

    dropdown.appendChild(frag);
    dropdown.style.display = 'block';
  });

  dropdown.addEventListener('click', (e) => {
    const item = e.target.closest('.search-item');
    if (!item || item.classList.contains('disabled')) return;

    const name = item.dataset.name;
    if (!name) return;

    // Find index of this name in full list
    const index = ALL_ROWS.findIndex(r => r['NAME'] === name);
    if (index === -1) return;

    // Calculate page (0-based index → 1-based page)
    const page = Math.floor(index / ITEMS_PER_PAGE) + 1;
    closeDropdown();
    input.blur();

    // Navigate and request highlight on that name
    gotoPage(page, name);
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-container')) {
      closeDropdown();
    }
  });
}

/* -------------------- INIT -------------------- */

build().catch(err => {
  console.error(err);
  document.getElementById('top-rank').innerHTML =
    '<tr><td colspan="6" style="color:red">Error loading leaderboard</td></tr>';
});
</script>

</body>
</html>
