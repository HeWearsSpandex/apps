<!-- Save as: this-month.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Bonus Metres – Current Month’s Leaderboard</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      display: flex; flex-direction: column;
    }
    .logo { text-align: center; margin: 20px 0 10px; }
    .logo img { max-width: 200px; height: auto; }
    h1 { text-align: center; margin: 0 0 20px; }
    table {
      width: 100%;
      max-width: 750px;
      margin: auto;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td { padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
    img.face { border-radius: 50%; vertical-align: middle; }
    td.rank { font-weight: bold; }
    .static-section { flex-shrink: 0; }
    .scrollable-section { flex-grow: 1; overflow: hidden; position: relative; }
    .scrollable-inner {
      height: 100%; overflow-y: auto;
      scrollbar-width: none; -ms-overflow-style: none;
    }
    .scrollable-inner::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>
  <div class="static-section">
    <div class="logo">
      <img src="/img/JHB Logo.png" alt="JHB Logo">
    </div>
    <h1>Bonus Metres – Current Month’s Leaderboard</h1>
    <table>
      <thead>
        <tr>
          <th>Rank</th>
          <th>Face</th>
          <th>Name</th>
          <th>Positional Change</th>
          <th>Bonus Metres</th>
          <th>Diff. from Leader</th>
        </tr>
      </thead>
      <tbody id="top-rank"></tbody>
    </table>
  </div>

  <div class="scrollable-section">
    <div class="scrollable-inner" id="scroll-container">
      <table>
        <tbody id="other-ranks"></tbody>
      </table>
    </div>
  </div>

  <script>
    const CSV_URL  = '/bonus-metres/data/actual_distances.csv';
    const IMG_PATH = '/img/';
    const PEOPLE = [
      'Adrian Lutic','Alex Nita','Antun Vidakovic','Bradley Turnstill',
      'Byron Claridge','Callum Evans','Cameron Gill','Christopher Scourfield','Craig Dolan',
      'Edward Shanley','Gary Mounce','George Norris','James Hickman','James Hodge-Brooks',
      'James Whiteoak','Joe Lambourne-Gillen',
      'Jonathan Thompson','Joseph Nixon','Joshua Powell','Joshua Rowberry',
      'Lewis Cannon','Liam Hammon','Luke Piller','Mark Sneap','Morgan Hemming',
      'Nicholas Kingshott','Richard Clanford','Robert Tamas',
      'Ryan Breslan','Ryan Manners','Tom Brooks','Tristan Allen','Tyler Webb','David Mahon','Darren Hatfield','Sam Brooks','Jason Bligh','Rhys Grant','Ross Wills','Ross Striplin','Jordan Reynolds','Mark Stafford',
      'William Garratt','Christopher Voisey','Ryan Turnstill','Jenna Turvey'
    ];

    async function loadImageElement(src, size) {
      return new Promise(res => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => res(img);
        img.onerror = () => {
          const c = document.createElement('canvas');
          c.width = c.height = size;
          const ctx = c.getContext('2d');
          ctx.fillStyle = '#ccc';
          ctx.fillRect(0, 0, size, size);
          res(c);
        };
        img.src = src;
      });
    }

    async function drawIcon(name, haloColor) {
      const base = 64, halo = haloColor ? 10 : 0, total = base + 2 * halo;
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const safe = encodeURIComponent(name.trim()) + '_cvface1.png';
      canvas.width = canvas.height = total;
      if (haloColor) {
        ctx.fillStyle = haloColor;
        ctx.beginPath();
        ctx.arc(total/2, total/2, base/2 + halo, 0, 2 * Math.PI);
        ctx.arc(total/2, total/2, base/2, 0, 2 * Math.PI);
        ctx.fill('evenodd');
      }
      const img = await loadImageElement(IMG_PATH + safe, base);
      ctx.drawImage(img, halo, halo, base, base);
      return canvas.toDataURL();
    }

    async function fetchData() {
      const r = await fetch(CSV_URL, { cache: 'no-cache' });
      if (!r.ok) throw new Error('Failed CSV: ' + r.status);
      const txt = await r.text();
      const lines = txt.trim().split(/\r?\n/);
      const keys = lines.shift().split(',').map(h => h.trim());
      return lines.map(l => {
        const cols = l.split(',');
        return keys.reduce((o, k, i) => (o[k] = (cols[i] || '').trim(), o), {});
      });
    }

    async function build() {
      const data = await fetchData();
      const rows = data
        .filter(r => r['T/M RANK'] && PEOPLE.includes(r['NAME']))
        .sort((a, b) => +a['T/M RANK'] - +b['T/M RANK']);

      const leaderValue = parseFloat(rows[0]['THIS MONTH']?.replace(/,/g, '') || '0');
      const counts = rows.reduce((a, r) => {
        const rk = +r['T/M RANK'];
        a[rk] = (a[rk] || 0) + 1;
        return a;
      }, {});

      const topEl = document.getElementById('top-rank');
      const otherEl = document.getElementById('other-ranks');
      topEl.innerHTML = '';
      otherEl.innerHTML = '';

      let lastRankValue = null, displayRank = 0;
      rows.forEach((r, idx) => {
        const val = +r['T/M RANK'];
        if (val !== lastRankValue) {
          displayRank = idx + 1;
          lastRankValue = val;
        }
        const value = parseFloat(r['THIS MONTH']?.replace(/,/g, '') || '0');
        r._display = displayRank;
        r._value = value;
        r._diff = leaderValue - value;
      });

      for (const r of rows) {
        const tm = +r['T/M RANK'];
        const lm = +r['T/M LAST RANK'] || Infinity;
        const tie = counts[tm] > 1;
        const rankTxt = (tie ? '=' : '') + r._display;
        const haloColor = r._display === 1 ? 'gold'
                          : r._display === 2 ? 'silver'
                          : r._display === 3 ? '#cd7f32' : null;
        const icon = await drawIcon(r['NAME'], haloColor);
        const size = 64 + (haloColor ? 10 : 0);
        const metresTxt = r._value.toLocaleString() + 'm';
        const diffTxt = r._diff === 0 ? 'Leader' : `-${r._diff.toLocaleString()}m`;
        const arrow = tm < lm ? 'Green%20Arrow.png' : tm > lm ? 'Red%20Arrow.png' : '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="rank">${rankTxt}</td>
          <td><img src="${icon}" width="${size}" height="${size}" class="face"></td>
          <td>${r['NAME']}</td>
          <td>${arrow ? `<img src="${IMG_PATH + arrow}" width="32" height="32">` : ''}</td>
          <td>${metresTxt}</td>
          <td>${diffTxt}</td>
        `;
        (r._display === 1 ? topEl : otherEl).appendChild(tr);
      }

      setTimeout(startPingPongScroll, 1000);
    }

    function startPingPongScroll() {
      const ct = document.getElementById('scroll-container');
      const speed = 0.05, pauseMs = 1000;
      let dir = 1, paused = false, last = performance.now(), elapsed = 0;

      function step(now) {
        const dt = now - last; last = now;
        if (paused) {
          elapsed += dt;
          if (elapsed >= pauseMs) { paused = false; elapsed = 0; }
        } else {
          ct.scrollTop += speed * dt * dir;
          const max = ct.scrollHeight - ct.clientHeight;
          if (ct.scrollTop >= max) { ct.scrollTop = max; dir = -1; paused = true; }
          else if (ct.scrollTop <= 0) { ct.scrollTop = 0; dir = 1; paused = true; }
        }
        requestAnimationFrame(step);
      }

      requestAnimationFrame(step);
    }

    build().catch(e => {
      console.error(e);
      document.querySelector('#top-rank').innerHTML =
        '<tr><td colspan="6" style="color:red">Error loading leaderboard</td></tr>';
    });
  </script>
</body>
</html>
